<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hostal HDQ - Ocupaci√≥n</title>
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #2c3e50; --success-color: #27ae60;
            --danger-color: #e74c3c; --light-bg: #f8f9fa; --dark-text: #34495e;
            --gradient-primary: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --gradient-header: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: var(--dark-text);
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--gradient-header); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .date { font-size: 1.2em; opacity: 0.9; }
        .controls { padding: 20px; background: var(--light-bg); border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .week-selector { display: flex; align-items: center; gap: 10px; }
        .week-selector button { background: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; }
        .week-selector button:hover { background: #2980b9; transform: translateY(-2px); }
        .current-week { font-weight: bold; }
        .occupancy-info { display: flex; align-items: center; gap: 15px; }
        .occupancy-rate { background: var(--success-color); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 1.1em; }
        .legend { display: flex; gap: 15px; font-size: 0.9em; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 3px; }
        .legend-libre { background-color: #d4edda; }
        .legend-ocupado { background-color: #f8d7da; }
        .table-container { padding: 20px; overflow-x: auto; }
        .occupancy-table { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .occupancy-table th { background: var(--gradient-primary); color: white; padding: 15px 10px; text-align: center; font-weight: bold; font-size: 1.1em; }
        .occupancy-table td { padding: 15px 10px; text-align: center; border: 1px solid #dee2e6; transition: all 0.3s ease; position: relative; }
        .occupancy-table td:first-child { background: var(--light-bg); color: var(--dark-text); font-weight: bold; font-size: 1.1em; }
        .libre { background-color: #d4edda; color: #155724; }
        .ocupado { background-color: #f8d7da; color: #721c24; font-weight: bold; cursor: pointer; }
        .ocupado:hover { background-color: #f5c6cb; transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .guest-name { font-size: 0.9em; line-height: 1.3; }
        .refresh-btn { position: fixed; bottom: 30px; right: 30px; background: var(--danger-color); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3); transition: all 0.3s ease; font-size: 1.5em; display: flex; align-items: center; justify-content: center; }
        .refresh-btn:hover { transform: translateY(-3px) rotate(180deg); }
        .loading { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>HOSTAL HDQ - OCUPACI√ìN</h1><div class="date" id="currentDate"></div></div>
        <div class="controls">
            <div class="week-selector">
                <button onclick="changeWeek(-1)">‚Üê Semana Anterior</button>
                <span class="current-week" id="currentWeek"></span>
                <button onclick="changeWeek(1)">Siguiente Semana ‚Üí</button>
            </div>
            <div class="occupancy-info">
                <div class="occupancy-rate" id="occupancyRate">Ocupaci√≥n: 0%</div>
                <div class="legend"><div class="legend-item"><div class="legend-color legend-libre"></div><span>Libre</span></div><div class="legend-item"><div class="legend-color legend-ocupado"></div><span>Ocupado</span></div></div>
            </div>
        </div>
        <div class="table-container"><div class="loading" id="loading"><div class="spinner"></div><div>Cargando datos...</div></div><table class="occupancy-table" id="occupancyTable" style="display: none;"><thead id="tableHeader"></thead><tbody id="tableBody"></tbody></table></div>
    </div>
    <button class="refresh-btn" onclick="loadData()" title="Actualizar datos">üîÑ</button>

    <script>
        // --- ¬°LISTO! Tu link de Google Sheets est√° configurado ---
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBPSZZfzoH0Xej-8smioPc4QLIDUEFg9Oyz5faJYl6LDp-21eJBdTTIVPTquhx1FU7vJoX7Bl4FbtM/pub?output=csv';

        let formData = [];
        const rooms = ['101', '102', '103', '201', '202', '203', '204', '205', '206', '207'];
        let currentWeekStart = new Date();

        function showMessage(elementId, title, message) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            document.getElementById('occupancyTable').style.display = 'none';
            el.innerHTML = `<div style="font-size: 1.2em; font-weight: bold; color: var(--danger-color);">${title}</div><div style="font-size: 0.9em; color: #666; margin-top: 10px;">${message}</div>`;
        }

        async function fetchGoogleSheetData() {
            try {
                const url = new URL(GOOGLE_SHEET_CSV_URL);
                url.searchParams.set('t', new Date().getTime()); // Evita la cach√©

                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error de red: ${response.status}`);
                const csvText = await response.text();
                
                const lines = csvText.trim().split(/\r?\n/);
                if (lines.length < 2) {
                     showMessage('loading', 'ü§î No se encontraron reservaciones', 'Se conect√≥ a Google Sheets, pero la hoja est√° vac√≠a. Agrega una reservaci√≥n en tu Google Form para verla aqu√≠.');
                    return [];
                }

                const headers = lines[0].split(',').map(h => h.trim());
                const nombreIndex = headers.indexOf('Nombre');
                const habitacionIndex = headers.indexOf('Habitaci√≥n');
                const fechaIngresoIndex = headers.indexOf('Fecha Ingreso');
                const fechaSalidaIndex = headers.indexOf('Fecha Salida');

                if ([nombreIndex, habitacionIndex, fechaIngresoIndex, fechaSalidaIndex].includes(-1)) {
                    showMessage('loading', '‚ùå Error de Columnas', `No se encontraron las columnas correctas en Google Sheets. Aseg√∫rate de que las preguntas en tu formulario se llamen exactamente: "Nombre", "Habitaci√≥n", "Fecha Ingreso", y "Fecha Salida".`);
                    return null;
                }
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const habitacionRaw = values[habitacionIndex] || '';
                    const newEntry = {
                        nombre: values[nombreIndex] || 'Sin Nombre',
                        fechaIngreso: values[fechaIngresoIndex],
                        fechaSalida: values[fechaSalidaIndex],
                        habitacion: habitacionRaw ? habitacionRaw.split(' ')[0] : '', 
                    };
                    if (newEntry.fechaIngreso && newEntry.fechaSalida && newEntry.habitacion) {
                        data.push(newEntry);
                    }
                }
                return data;

            } catch (error) {
                console.error('Error al cargar datos de Google Sheets:', error);
                showMessage('loading', '‚ùå Error al Cargar Datos', `Ocurri√≥ un problema: "${error.message}". Revisa que la URL de Google Sheets sea correcta.`);
                return null;
            }
        }
        
        function getMonday(d) { const date = new Date(d); const day = date.getDay(); const diff = date.getDate() - day + (day === 0 ? -6 : 1); return new Date(date.setDate(diff)); }
        function formatDate(d) { return d.toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
        function formatDateShort(d) { const day = d.toLocaleDateString('es-CL', { weekday: 'short' }); return `${day.charAt(0).toUpperCase() + day.slice(1)} ${d.getDate()}`; }
        function generateWeekDates(d) { const dates = []; for (let i = 0; i < 7; i++) { const date = new Date(d); date.setDate(d.getDate() + i); dates.push(date); } return dates; }
        
        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split(/[/ ]/);
            // Formato de Google Forms en Chile: dd/MM/yyyy
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function isDateInRange(checkDate, startStr, endStr) {
            const d = new Date(checkDate); d.setHours(0, 0, 0, 0);
            const s = parseDate(startStr);
            const e = parseDate(endStr);
            if (!s || !e) return false;
            s.setHours(0, 0, 0, 0);
            e.setHours(0, 0, 0, 0);
            // El d√≠a de salida (checkout) la habitaci√≥n ya est√° libre.
            // Por eso usamos "menor que" (<) la fecha de salida.
            return d >= s && d < e;
        }

        function getGuestForRoomAndDate(room, date) { for (const guest of formData) { if (guest.habitacion === room && isDateInRange(date, guest.fechaIngreso, guest.fechaSalida)) { return guest.nombre.trim(); } } return null; }
        function calculateOccupancy(dates) { let total = rooms.length * dates.length; if (total === 0) return 0; let occupied = 0; dates.forEach(d => rooms.forEach(r => { if (getGuestForRoomAndDate(r, d)) occupied++; })); return Math.round((occupied / total) * 100); }
        function renderTable() { const dates = generateWeekDates(currentWeekStart); document.getElementById('tableHeader').innerHTML = `<tr><th>Hab.</th>${dates.map(d => `<th>${formatDateShort(d)}</th>`).join('')}</tr>`; document.getElementById('tableBody').innerHTML = rooms.map(r => `<tr><td>${r}</td>${dates.map(d => { const guest = getGuestForRoomAndDate(r, d); return `<td class="${guest ? 'ocupado' : 'libre'}" title="${guest || 'Libre'}">${guest ? `<div class="guest-name">${guest}</div>` : ''}</td>`; }).join('')}</tr>`).join(''); document.getElementById('occupancyRate').textContent = `Ocupaci√≥n: ${calculateOccupancy(dates)}%`; document.getElementById('currentDate').textContent = formatDate(new Date()); document.getElementById('currentWeek').textContent = `${formatDateShort(dates[0])} - ${formatDateShort(dates[6])}`; }
        function changeWeek(direction) { currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7)); renderTable(); }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('occupancyTable').style.display = 'none';
            const data = await fetchGoogleSheetData();
            if (data !== null) {
                formData = data;
                renderTable();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('occupancyTable').style.display = 'table';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            currentWeekStart = getMonday(new Date());
            loadData();
        });
        // Actualiza los datos autom√°ticamente cada 5 minutos
        setInterval(loadData, 300000);
    </script>
</body>
</html>

